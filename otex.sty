\NeedsTeXFormat{LaTeX2e}
\RequirePackage{expl3}
\ProvidesExplPackage {otex} {2025-01-16} {1.0} {Orion's Custom Package}

% ==============================================================================
% 模块变量声明 (Variable Declarations)
% ------------------------------------------------------------------------------
% 语法讲解:
% \bool_new:N <variable>
%   创建一个新的布尔(boolean)变量，初始值为 false。
%   :N 表示参数是一个单一的控制序列 (Command/Control Sequence)。
%
% 命名规范 (Naming Convention):
%   \g_otex_..._bool
%   ^ ^    ^       ^
%   | |    |       |__ 类型后缀 (Type): 表示这是一个布尔变量
%   | |    |__________ 变量名 (Name): 描述变量用途
%   | |_______________ 模块名 (Module): 属于 'otex' 包
%   |_________________ 作用域 (Scope): Global (全局变量)
% ==============================================================================

\bool_new:N \g_otex_load_layout_bool    % 是否加载页面布局模块 (geometry 等)
\bool_new:N \g_otex_load_fonts_bool     % 是否加载字体配置模块
\bool_new:N \g_otex_load_ctex_bool      % 是否加载中文支持 (ctex)
\bool_new:N \g_otex_load_theorems_bool  % 是否加载定理环境 (amsthm 等)
\bool_new:N \g_otex_load_hyperref_bool  % 是否加载超链接支持 (hyperref)
\bool_new:N \g_otex_load_cleveref_bool  % 是否加载智能引用支持 (cleveref)
\bool_new:N \g_otex_load_caption_bool   % 是否加载图表标题支持 (caption)
\bool_new:N \g_otex_load_algo_bool      % 是否加载算法模块 (algorithm2e/algorithmicx)
\bool_new:N \g_otex_load_math_bool      % 是否加载数学模块 (amsmath, mathtools 等)
\bool_new:N \g_otex_load_graphics_bool  % 是否加载图形模块 (graphicx, tikz 等)
\bool_new:N \g_otex_load_listings_bool  % 是否加载 listings 代码高亮
\bool_new:N \g_otex_load_minted_bool    % 是否加载 minted 代码高亮
\bool_new:N \g_otex_load_tables_bool    % 是否加载表格模块 (booktabs 等)
\bool_new:N \g_otex_english_bool        % 是否开启英文模式 (影响日期格式、ctex 选项等)
\bool_new:N \g_otex_is_std_class_bool   % 是否检测到标准文档类 (article, book, report 等)

% ==============================================================================
% 智能默认值设置 (Smart Defaults)
% ------------------------------------------------------------------------------
% 根据文档类自动启用/禁用某些功能
% ==============================================================================

% \@ifclassloaded 是 LaTeX2e 的命令，但在 expl3 中也可以使用。
% 作用：检查某个文档类是否已被加载。
% 语法：\@ifclassloaded{class-name}{true-code}{false-code}

% 检查当前是否在使用标准文档类或其 CTEX 变体
\@ifclassloaded{article}  { \bool_gset_true:N \g_otex_is_std_class_bool } {}
\@ifclassloaded{report}   { \bool_gset_true:N \g_otex_is_std_class_bool } {}
\@ifclassloaded{book}     { \bool_gset_true:N \g_otex_is_std_class_bool } {}
\@ifclassloaded{ctexart}  { \bool_gset_true:N \g_otex_is_std_class_bool } {}
\@ifclassloaded{ctexrep}  { \bool_gset_true:N \g_otex_is_std_class_bool } {}
\@ifclassloaded{ctexbook} { \bool_gset_true:N \g_otex_is_std_class_bool } {}

% 语法讲解:
% \bool_gset_true:N <variable>
%   将全局布尔变量设置为真 (true)。
%   g = global (全局)
%   set = 设置值
%
% \bool_if:NTF <bool_var> { <true_code> } { <false_code> }
%   条件判断语句。
%   :N  = 参数是一个控制序列 (即变量名)
%   :TF = 需要提供 True分支 和 False分支 的代码块

% 如果是标准文档类，默认开启所有功能
\bool_if:NTF \g_otex_is_std_class_bool
  {
    % --- 标准模式：默认开启一切 ---
    \bool_gset_true:N \g_otex_load_layout_bool
    \bool_gset_true:N \g_otex_load_fonts_bool
    \bool_gset_true:N \g_otex_load_ctex_bool
    \bool_gset_true:N \g_otex_load_theorems_bool
    \bool_gset_true:N \g_otex_load_hyperref_bool
    \bool_gset_true:N \g_otex_load_cleveref_bool
    \bool_gset_true:N \g_otex_load_caption_bool
    \bool_gset_true:N \g_otex_load_algo_bool
    \bool_gset_true:N \g_otex_load_math_bool
    \bool_gset_true:N \g_otex_load_graphics_bool
    \bool_gset_true:N \g_otex_load_listings_bool
    \bool_gset_true:N \g_otex_load_minted_bool
    \bool_gset_true:N \g_otex_load_tables_bool
  }
  {
    % --- 安全模式 (Safe Mode) ---
    % 非标准类 (如 beamer, standalone) 检测到时进入此分支。
    
    % 语法讲解:
    % \msg_new:nnn { <module> } { <msg_name> } { <text> }
    %   定义一条新消息。
    % \msg_warning:nn { <module> } { <msg_name> }
    %   发出一条警告消息。
    
    \msg_new:nnn { otex } { safe-mode } { Non-standard~class~detected!~Defaulting~to~Safe~Mode. }
    \msg_warning:nn { otex } { safe-mode }
    
    % 关闭可能引起冲突的模块
    \bool_gset_false:N \g_otex_load_layout_bool
    \bool_gset_false:N \g_otex_load_fonts_bool
    \bool_gset_false:N \g_otex_load_ctex_bool
    \bool_gset_false:N \g_otex_load_theorems_bool
    \bool_gset_false:N \g_otex_load_hyperref_bool
    \bool_gset_false:N \g_otex_load_cleveref_bool
    \bool_gset_false:N \g_otex_load_caption_bool
    \bool_gset_false:N \g_otex_load_algo_bool
    
    % 开启通常无害的功能
    \bool_gset_true:N \g_otex_load_math_bool
    \bool_gset_true:N \g_otex_load_graphics_bool
    \bool_gset_true:N \g_otex_load_listings_bool
    \bool_gset_false:N \g_otex_load_minted_bool % safe mode下也默认关闭minted以防万一
    \bool_gset_true:N \g_otex_load_tables_bool
  }

% ==============================================================================
% 选项定义 (Option Definitions)
% ------------------------------------------------------------------------------
% 使用 l3keys 定义 key-value 选项接口
% ==============================================================================
\RequirePackage { l3keys2e } % 允许 LaTeX2e 宏包 (\usepackage[...]{...}) 使用 expl3 的 key-value 处理功能

% 语法讲解:
% \keys_define:nn { <module> } { <key_defs> }
%   定义一组键值对选项。
%   :nn 表示两个参数都是普通的大括号包围的文本。

\keys_define:nn { otex }
  {
    % 语法讲解:
    % key_name .bool_set:N = \variable
    %   定义一个名为 key_name 的选项，当用户使用 key=true/false 时，
    %   自动将结果存储到 \variable 中。
    %
    % key_name .default:n = true
    %   定义当用户只写 'key_name' 而不写 '=value' 时，默认视作 '=true'。
    
    layout      .bool_set:N = \g_otex_load_layout_bool,
    layout      .default:n  = true,
    
    fonts       .bool_set:N = \g_otex_load_fonts_bool,
    fonts       .default:n  = true,
    
    ctex        .bool_set:N = \g_otex_load_ctex_bool,
    ctex        .default:n  = true,
    
    theorems    .bool_set:N = \g_otex_load_theorems_bool,
    theorems    .default:n  = true,
    
    hyperref    .bool_set:N = \g_otex_load_hyperref_bool,
    hyperref    .default:n  = true,
    
    cleveref    .bool_set:N = \g_otex_load_cleveref_bool,
    cleveref    .default:n  = true,
    
    caption     .bool_set:N = \g_otex_load_caption_bool,
    caption     .default:n  = true,
    
    algo        .bool_set:N = \g_otex_load_algo_bool,
    algo        .default:n  = true,
    
    % 语法讲解:
    % key_name .meta:n = { <other_keys> }
    %   定义一个"元选项" (Meta Key)。当用户使用此 key 时，
    %   实际效果等同于设置了大括号内的那些 keys。
    %   这里 #1 代表用户传递给 alias 的值。
    algorithms  .meta:n     = { algo = #1 },
    algorithms  .default:n  = true,
    
    math        .bool_set:N = \g_otex_load_math_bool,
    math        .default:n  = true,
    
    graphics    .bool_set:N = \g_otex_load_graphics_bool,
    graphics    .default:n  = true,
    
    listings    .bool_set:N = \g_otex_load_listings_bool,
    listings    .default:n  = true,
    
    minted      .bool_set:N = \g_otex_load_minted_bool,
    minted      .default:n  = true,
    
    tables      .bool_set:N = \g_otex_load_tables_bool,
    tables      .default:n  = true,
    
    english     .bool_set:N = \g_otex_english_bool,
    english     .default:n  = true,
    
    % 反向别名 (Negative Aliases)
    % 方便用户使用 \usepackage[no-math]{otex} 这种形式
    nolayout    .meta:n = { layout = false },
    nofonts     .meta:n = { fonts = false },
    noctex      .meta:n = { ctex = false },
    notheorems  .meta:n = { theorems = false },
    nohyperref  .meta:n = { hyperref = false },
    nocleveref  .meta:n = { cleveref = false },
    nocaption   .meta:n = { caption = false },
    noalgo      .meta:n = { algo = false },
    noalgorithms.meta:n = { algo = false },
    nomath      .meta:n = { math = false },
    nographics  .meta:n = { graphics = false },
    nolistings  .meta:n = { listings = false },
    nominted    .meta:n = { minted = false },
    notables    .meta:n = { tables = false },
  }

% 语法讲解:
% \ProcessKeysOptions { <module> }
%   处理当前包接收到的选项。它会查看 \usepackage[...]{otex} 中的内容，
%   并匹配上面定义的 keys。这一步会将用户选项应用到变量中。
\ProcessKeysOptions { otex }

% ==============================================================================
% 冲突熔断 (Conflict Resolution)
% ------------------------------------------------------------------------------
% 检查是否已加载冲突包，如果已加载则自动关闭对应模块，防止报错。
% ==============================================================================

% 定义冲突提示消息模板
% #1 是占位符，会被具体包名替换
\msg_new:nnn { otex } { package-clash } { Package~'#1'~detected.~Disabling~otex~#1. }

% 检测 geometry
% 如果用户在加载 otex 之前已经 \usepackage{geometry}，
% 则不应再让 otex 加载 geometry，否则会报错 "Option clash"。
\@ifpackageloaded { geometry } {
  \bool_gset_false:N \g_otex_load_layout_bool
  % \msg_info:nnn 发送一条 Info 级别的消息
  \msg_info:nnn { otex } { package-clash } { layout }
} {}

% 检测 hyperref
\@ifpackageloaded { hyperref } {
  \bool_gset_false:N \g_otex_load_hyperref_bool
  \msg_info:nnn { otex } { package-clash } { hyperref }
} {}

% 检测 cleveref
\@ifpackageloaded { cleveref } {
  \bool_gset_false:N \g_otex_load_cleveref_bool
  \msg_info:nnn { otex } { package-clash } { cleveref }
} {}

% 检测 caption
\@ifpackageloaded { caption } {
  \bool_gset_false:N \g_otex_load_caption_bool
  \msg_info:nnn { otex } { package-clash } { caption }
} {}

% 检测 algorithm
\@ifpackageloaded { algorithm } {
  \bool_gset_false:N \g_otex_load_algo_bool
  \msg_info:nnn { otex } { package-clash } { algorithm2e }
} {}

% 检测 minted
\@ifpackageloaded { minted } {
  \bool_gset_false:N \g_otex_load_minted_bool
  \msg_info:nnn { otex } { package-clash } { minted }
} {}

% 检查定理环境
% \@ifundefined{command}{true}{false} 检查命令是否未定义
% 如果 \theorem 命令已存在，说明可能加载了 amsthm 或 ntheorem
\@ifundefined { theorem } {} {
  \bool_gset_false:N \g_otex_load_theorems_bool
  \msg_info:nnn { otex } { package-clash } { theorems }
}

% ==============================================================================
% 模块加载 (Module Loading)
% ------------------------------------------------------------------------------
% 根据布尔变量的最终状态 (用户选项 + 自动检测 + 冲突熔断)，加载对应模块。
% ==============================================================================

% 1. 基础模块 (Always loaded) - 包含一些通用宏
\RequirePackage { otex/otex-base }

% 语法讲解:
% \bool_if:NT <bool_var> { <code_if_true> }
%   如果变量为真，则执行代码。这是 \bool_if:NTF 的简化版，省略了 False 分支。

% 2. 数学模块
\bool_if:NT \g_otex_load_math_bool {
  \RequirePackage { otex/otex-math }
}

% 3. 定理模块
\bool_if:NT \g_otex_load_theorems_bool {
  \RequirePackage { otex/otex-theorems }
}

% 4. 算法模块
\bool_if:NT \g_otex_load_algo_bool {
  \RequirePackage { otex/otex-algo }
}

% 5. 代码高亮模块
% 逻辑: 如果 listings 或 minted 任意一个被启用，就加载 code 模块。
% 具体使用哪个包，由 otex-code 内部再次判断。
% 语法讲解:
% \bool_if:nTF { <expression> } { <code_if_true> } { <code_if_false> }
%   支持逻辑表达式，如 || (或), && (与), ! (非)。
%   :n 表示参数是普通文本(表达式)。
\bool_if:nTF { \g_otex_load_listings_bool || \g_otex_load_minted_bool }
  { \RequirePackage { otex/otex-code } }
  {}

% 6. 图形模块
\bool_if:NT \g_otex_load_graphics_bool {
  \RequirePackage { otex/otex-graphics }
}

% 7. 标题模块
\bool_if:NT \g_otex_load_caption_bool {
  \RequirePackage { otex/otex-caption }
}

% 8. 表格模块
\bool_if:NT \g_otex_load_tables_bool {
  \RequirePackage { otex/otex-tables }
}

% 9. 中文/字体模块
% 将 fonts 和 ctex 参数的逻辑交给该模块内部或通过开关处理
% 这里我们总是加载它，它内部会检查 \g_otex_load_ctex_bool 等变量
\RequirePackage { otex/otex-chinese } 

% 10. 字体配置 (Fonts)
% 放在中文模块之后加载，以确保 ctex 已就绪（如果开启的话）
\RequirePackage { otex/otex-fonts } 

% 11. 页面布局
\bool_if:NT \g_otex_load_layout_bool {
  \RequirePackage { otex/otex-layout }
}

% 12. 引用模块 (包含 hyperref 和 cleveref)
% 具体的加载逻辑在子模块内部实现, 这里总是引入
\RequirePackage { otex/otex-refs }

% 13. 自定义命令
\RequirePackage { otex/otex-commands }

\endinput