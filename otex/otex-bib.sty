\ProvidesExplPackage {otex/otex-bib} {2026-01-16} {1.1} {Orion's Bibliography}

% 文献引用体系配置
% 依赖 otex-pkgcheck 的智能冲突检测：
% 1. 若 biblatex 或 natbib 已加载，otex_safe_require 会自动跳过并警告（或仅跳过配置）。
% 2. 若检测到互斥包（如 biblatex vs natbib），也会自动警告并跳过。
\cs_new_protected:Npn \otex_setup_biblatex_config:
{
  % 国际化增强：为 biblatex 后端注入中文文献列表标题设置
  \cs_if_exist:NT \DefineBibliographyStrings
  {
    \bool_if:NF \g_otex_english_bool
    {
      \DefineBibliographyStrings{english}{
        bibliography = {参考文献},
        references = {参考文献},
      }
    }
  }

  % 视觉优化：调整 biblatex 链接断行惩罚值
  \cs_if_exist:NT \setcounter
  {
    \setcounter{biburlnumpenalty}{100}
    \setcounter{biburlucpenalty}{100}
    \setcounter{biburllcpenalty}{100}
  }
}

\str_case:VnF \g_otex_bib_backend_tl
{
  {biber} { \otex_safe_require:nnnn { biblatex } { backend=biber, style=\g_otex_bib_style_tl, sorting=none, doi=true } { \printbibliography } { \otex_setup_biblatex_config: } }
  {bibtex} { \otex_safe_require:nnnn { biblatex } { backend=bibtex, style=\g_otex_bib_style_tl, sorting=none, doi=true } { \printbibliography } { \otex_setup_biblatex_config: } }
  {natbib}   { \otex_safe_require:nnnn { natbib } { numbers, sort&compress } { \citep } {} }
}
{
  \otex_safe_require:nnnn { biblatex } { backend=biber, style=ieee } { \printbibliography } { \otex_setup_biblatex_config: }
}

% ------------------------------------------------------------------------------
% 兼容层：如果 biblatex 无法加载（由于 natbib 冲突），则为 biblatex 常用命令提供 natbib 封装
% ------------------------------------------------------------------------------
\tl_new:N \g_otex_bib_resource_tl
\tl_new:N \l_otex_bib_tmp_tl

\otex_provide_command:Nnn \addbibresource { m }
{
  \tl_gset:Nn \g_otex_bib_resource_tl { #1 }
}

\otex_provide_command:Nnn \printbibliography { }
{
  \tl_if_empty:NF \g_otex_bib_resource_tl
  {
    \tl_set:NV \l_otex_bib_tmp_tl \g_otex_bib_resource_tl
    % 移除 .bib 后缀，因为 \bibliography 命令不需要它
    \regex_replace_once:nnN { \.bib$ } { } \l_otex_bib_tmp_tl
    \exp_args:NV \bibliography \l_otex_bib_tmp_tl
  }
}

\endinput
