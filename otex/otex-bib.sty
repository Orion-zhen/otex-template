\ProvidesExplPackage {otex/otex-bib} {2026-01-16} {1.1} {Orion's Bibliography}

% 文献引用体系检测：通过探测核心命令 (\printbibliography, \citep) 来判断 biblatex 或 natbib 的加载状态
\bool_new:N \l_otex_bib_configured_bool

\@ifpackageloaded{biblatex}{\bool_set_true:N \l_otex_bib_configured_bool}{}
\@ifpackageloaded{natbib}{\bool_set_true:N \l_otex_bib_configured_bool}{}
\cs_if_exist:NT \printbibliography {\bool_set_true:N \l_otex_bib_configured_bool}
\cs_if_exist:NT \citep {\bool_set_true:N \l_otex_bib_configured_bool}

\bool_if:NT \l_otex_bib_configured_bool
{
  \msg_warning:nnnn { otex } { pkg-skip } { biblatex/natbib } { bibliography~already~configured }
}

\bool_if:NF \l_otex_bib_configured_bool
{
  \cs_new_protected:Npn \otex_setup_biblatex_config:
  {
    % 国际化增强：为 biblatex 后端注入中文文献列表标题设置
    \cs_if_exist:NT \DefineBibliographyStrings
    {
      \bool_if:NF \g_otex_english_bool
      {
        \DefineBibliographyStrings{english}{
          bibliography = {参考文献},
          references = {参考文献},
        }
      }
    }

    % 视觉优化：调整 biblatex 链接断行惩罚值
    \cs_if_exist:NT \setcounter
    {
      \setcounter{biburlnumpenalty}{100}
      \setcounter{biburlucpenalty}{100}
      \setcounter{biburllcpenalty}{100}
    }
  }

  \str_case:VnF \g_otex_bib_backend_tl
  {
    {biber} { \otex_safe_require:nnnn { biblatex } { backend=biber, style=\g_otex_bib_style_tl, sorting=none, doi=true } {} { \otex_setup_biblatex_config: } }
    {bibtex} { \otex_safe_require:nnnn { biblatex } { backend=bibtex, style=\g_otex_bib_style_tl, sorting=none, doi=true } {} { \otex_setup_biblatex_config: } }
    {natbib}   { \otex_safe_require:nnnn { natbib } { numbers, sort&compress } {} {} }
  }
  {
    \otex_safe_require:nnnn { biblatex } { backend=biber, style=ieee } {} { \otex_setup_biblatex_config: }
  }
}

\endinput
