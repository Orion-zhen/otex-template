\ProvidesExplPackage {otex/otex-chinese} {2026-01-17} {1.2} {Orion's Chinese Support}

\bool_if:NF \g_otex_load_ctex_bool { \endinput }

% pdfTeX 引擎检测：xeCJK 仅支持 XeTeX，但 ctex + CJK 可以在 pdfLaTeX 下工作
\sys_if_engine_pdftex:T
{
  \bool_if:NTF \g_otex_english_bool
  {
    % In English mode on pdfTeX, avoid loading ctex to prevent font conflicts (e.g. unisong20)
    % This is a "best effort" safe default.
    \msg_new:nnn { otex } { ctex-pdftex-skipped } { pdfTeX~detected~in~English~mode.~Skipping~ctex~loading. }
    \msg_info:nn { otex } { ctex-pdftex-skipped }
  }
  {
    \msg_new:nnn { otex } { ctex-pdftex } { pdfTeX~detected.~Loading~ctex~with~CJK~backend~(limited~CJK~support). }
    \msg_warning:nn { otex } { ctex-pdftex }
    \otex_require:nnnn { ctex } { UTF8, scheme=chinese, heading=false, fontset=none } {} {}
  }
  \endinput
}

\bool_new:N \l_otex_safe_header_bool
% Dynamic check: If titlesec is loaded, it implies the class controls headings.
% In that case, we MUST NOT let ctex mess with them.
\@ifpackageloaded { titlesec }
{ \bool_set_false:N \l_otex_safe_header_bool }
{ \bool_set_true:N \l_otex_safe_header_bool }

\tl_new:N \l_otex_ctex_scheme_tl
\bool_if:NTF \g_otex_english_bool
{ \tl_set:Nn \l_otex_ctex_scheme_tl { plain } }
{ \tl_set:Nn \l_otex_ctex_scheme_tl { chinese } }

\bool_if:NTF \l_otex_safe_header_bool
{
  \otex_require:nnnn { ctex } { UTF8, scheme=\l_otex_ctex_scheme_tl, heading=true } {} {}
}
{
  % Conflict detected (titlesec loaded): Backoff to plain scheme, disable heading, AND disable fontset
  \msg_new:nnn { otex } { heading-backoff } { Package~'titlesec'~detected.~Disabling~ctex~heading~modification~and~fontset. }
  \msg_warning:nn { otex } { heading-backoff }
  \otex_require:nnnn { ctex } { UTF8, scheme=plain, heading=false, fontset=none } {} {}
}

\endinput
