\ProvidesExplPackage {otex/otex-chinese} {2026-01-18} {1.3} {Orion's Chinese Support}

\bool_if:NF \g_otex_load_ctex_bool { \endinput }

% pdfTeX 引擎检测：xeCJK 仅支持 XeTeX，但 ctex + CJK 可以在 pdfLaTeX 下工作
\sys_if_engine_pdftex:T
{
  \bool_if:NTF \g_otex_english_bool
  {
    % In English mode on pdfTeX, avoid loading ctex to prevent font conflicts (e.g. unisong20)
    % This is a "best effort" safe default.
    \msg_new:nnn { otex } { ctex-pdftex-skipped } { pdfTeX~detected~in~English~mode.~Skipping~ctex~loading. }
    \msg_info:nn { otex } { ctex-pdftex-skipped }
  }
  {
    \msg_new:nnn { otex } { ctex-pdftex } { pdfTeX~detected.~Loading~ctex~with~CJK~backend~(limited~CJK~support). }
    \msg_warning:nn { otex } { ctex-pdftex }
    \otex_safe_require:nnnn { ctex } { UTF8, scheme=chinese, heading=false, fontset=none } { \CTEXsetup } {}
  }
  \endinput
}

% 方案选路：根据全局语言布尔值设置 ctex 的文案风格 (scheme=chinese/plain)
\tl_new:N \l_otex_ctex_scheme_tl
\bool_if:NTF \g_otex_english_bool
{ \tl_set:Nn \l_otex_ctex_scheme_tl { plain } }
{ \tl_set:Nn \l_otex_ctex_scheme_tl { chinese } }

% 接口拆分策略：显式禁用 ctex 的标题管理 (heading=false)，转而由 titlesec 子模块统一接管。
% 这种设计使得标题样式的定制更为灵活，且能有效规避 ctex 与部分文档类的底层冲突。
\otex_safe_require:nnnn { ctex } { UTF8, scheme=\l_otex_ctex_scheme_tl, heading=false } { \CTEXsetup } {}

% 加载专门的标题管理子模块 (仅在全局选项开启时激活)
\RequirePackage { otex/otex-titlesec }

\endinput
