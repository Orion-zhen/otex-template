\ProvidesExplPackage {otex/otex-code} {2026-01-16} {1.1} {Orion's Code Highlighting}

\definecolor{code_bg}{rgb}{0.95, 0.95, 0.95}

% 代码高亮方案 A (minted)：基于 Pygments 的高质量染色方案，通过 \usemintedstyle 探测冲突
\bool_if:NT \g_otex_load_minted_bool
{
  % 安全加载流程：验证 shell escape 权限并探测 \usemintedstyle 是否已定义
  \int_compare:nNnTF { \pdf@shellescape } = { 1 }
  {
    \otex_safe_require:nnnn { minted } {} { \usemintedstyle }
    {
      \bool_if:NF \l_otex_pkg_preloaded_bool
      {
        \usemintedstyle{friendly}
        \setminted{bgcolor=code_bg, fontsize=\small, linenos, breaklines, frame=lines}
      }
    }
  }
  {
    \msg_new:nnn { otex } { minted-skip } { 系统检测到 Shell~escape~已禁用。自动跳过~minted~并重定向至~listings~回退方案。 }
    \msg_warning:nn { otex } { minted-skip }
    \bool_gset_false:N \g_otex_load_minted_bool
  }
}

% 代码高亮方案 B (listings)：原生 LaTeX 方案，兼作 minted 的安全回退点，通过 \lstset 探测冲突
\bool_if:NT \g_otex_load_listings_bool
{
  % 安全加载流程：检查 \lstset 命令是否存在以规避重复定义
  \otex_safe_require:nnnn { listings } {} { \lstset }
  {
    \bool_if:NF \l_otex_pkg_preloaded_bool
    {
      \lstset{
        backgroundcolor=\color{code_bg},
        basicstyle=\ttfamily\small,
        keywordstyle=\bfseries\color{blue},
        commentstyle=\itshape\color{green!40!black},
        stringstyle=\color{purple},
        frame=single,
        breaklines=true,
        numbers=left
      }
    }
  }
}

% 降级处理：若未开启 minted，则通过映射环境模拟其接口，确保源码兼容
\bool_if:NF \g_otex_load_minted_bool
{
  % 接口仿真：将 minted 环境重定向至 listings 逻辑
  % 兼容用法：\begin{minted}[选项]{语言}
  
  % 定义垫片键值组 (Listings Compat-Layer)
  % 既然 lstnewenvironment 会自动解析首个可选参数，我们必须让 listings 认识这些 minted 专用键
  % 否则会直接报错 key undefined。我们通过 hack 内部命令 \lst@Key 注入定义。
  
  \cs_if_exist:cT { lstset }
  {
    \cs_set:cpn { KV@lst@linenos } #1 { \lstset{numbers=left} }
    \cs_set:cpn { KV@lst@linenos@default } { \lstset{numbers=left} }

    \cs_set:cpn { KV@lst@bgcolor } #1 { \lstset{backgroundcolor=\color{#1}} }
    
    \cs_set:cpn { KV@lst@fontsize } #1 { \lstset{basicstyle=\ttfamily#1} }
    \cs_set:cpn { KV@lst@fontsize@default } { \lstset{basicstyle=\ttfamily\small} }
  }

  \lstnewenvironment{minted}[2][]
  {
    \lstset{language=#2}
  }
  {
    % End code
  }

  % 接口仿真：将 行内 \mintinline 命令映射至 \lstinline
  % 兼容用法：\mintinline[选项]{语言}{代码}
  \ProvideDocumentCommand{\mintinline}{O{}m}{%
    \lstinline[#1,language=#2]%
  }

  % 浮动体增强：若当前文档类未预定义 listing 环境，则利用 float 包手动补齐
  \cs_if_exist:NF \c@listing
  {
    \RequirePackage{float}
    \newfloat{listing}{htbp}{lol}
    \floatname{listing}{Listing}
  }
}

\otex_provide_command:Nnn \code { m }
  {
    \bool_if:NTF \g_otex_load_minted_bool
    { \mintinline[bgcolor=code_bg,breaklines]{text}{#1} }
    { \colorbox{code_bg}{\texttt{\small #1}} }
  }

\endinput
