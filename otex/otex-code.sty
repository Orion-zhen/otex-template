\ProvidesExplPackage {otex/otex-code} {2026-01-16} {1.1} {Orion's Code Highlighting}

\definecolor{code_bg}{rgb}{0.95, 0.95, 0.95}

% Minted - with symbol detection
\bool_if:NT \g_otex_load_minted_bool
{
  % Check if minted is already loaded (by template)
  \cs_if_exist:NTF \usemintedstyle
  {
    \msg_warning:nnnn { otex } { pkg-skip } { minted } { \\usemintedstyle~already~defined }
  }
  {
    \int_compare:nNnTF { \pdf@shellescape } = { 1 }
    {
      \otex_require:nnnn { minted } {} {} {}
      \usemintedstyle{friendly}
      \setminted{bgcolor=code_bg, fontsize=\small, linenos, breaklines, frame=lines}
    }
    {
      \msg_new:nnn { otex } { minted-skip } { Shell~escape~disabled.~Skipping~minted~(using~listings~fallback). }
      \msg_warning:nn { otex } { minted-skip }
      \bool_gset_false:N \g_otex_load_minted_bool
    }
  }
}

% Listings (Fallback or primary if minted not loaded) - with symbol detection
\bool_if:NT \g_otex_load_listings_bool
{
  % Check if listings is already loaded (by template)
  \cs_if_exist:NTF \lstset
  {
    \msg_warning:nnnn { otex } { pkg-skip } { listings } { \\lstset~already~defined }
  }
  {
    \otex_require:nnnn { listings } {} {} {}
  }
  % Configure listings if loaded (either by us or template)
  \@ifpackageloaded{listings}
  {
    \lstset{
      backgroundcolor=\color{code_bg},
      basicstyle=\ttfamily\small,
      keywordstyle=\bfseries\color{blue},
      commentstyle=\itshape\color{green!40!black},
      stringstyle=\color{purple},
      frame=single,
      breaklines=true,
      numbers=left
    }
  }
  {}
}

% Fallback for minted environment if not loaded
\bool_if:NF \g_otex_load_minted_bool
{
  % Map minted environment to listings
  % Usage: \begin{minted}[options]{language}
  \lstnewenvironment{minted}[2][]
  {
    \lstset{#1}
    \lstset{language=#2}
  }
  {}

  % Map \mintinline to \lstinline
  % Usage: \mintinline[options]{language}{code}
  \ProvideDocumentCommand{\mintinline}{O{}m}{%
    \lstinline[#1,language=#2]%
  }

  % Map listing float environment if not defined
  \cs_if_exist:NF \c@listing
  {
    \RequirePackage{float}
    \newfloat{listing}{htbp}{lol}
    \floatname{listing}{Listing}
  }
}

\otex_provide_command:Nnn \code { m }
  {
    \bool_if:NTF \g_otex_load_minted_bool
    { \mintinline[bgcolor=code_bg,breaklines]{text}{#1} }
    { \colorbox{code_bg}{\texttt{\small #1}} }
  }

\endinput
