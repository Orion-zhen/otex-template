\ProvidesExplPackage {otex/otex-fonts} {2026-01-17} {1.2} {Orion's Font Configuration}

\bool_if:NF \g_otex_load_fonts_bool { \endinput }

% pdfTeX 引擎检测：fontspec 仅支持 XeTeX/LuaTeX
\sys_if_engine_pdftex:T
{
  \msg_new:nnn { otex } { fonts-pdftex-skip } { pdfTeX~detected.~Skipping~fontspec~(requires~XeTeX/LuaTeX). }
  \msg_warning:nn { otex } { fonts-pdftex-skip }
  \endinput
}

% 字体生命周期管理：在正式激活 fontspec 前预检当前字体状态。
% 判断 \rmdefault 是否仍为内核标准字体 (cmr/lmr)。若检测到用户已通过文档类或第三方包指定了非标字体，
% otex 将自动启动“静默退避”机制 (font-set=none)，确保外部自定义设置的完整性。
\str_if_eq:VnT \g_otex_font_set_tl { auto }
{
  \tl_set:Nx \l_otex_rmdefault_tl { \rmdefault }

  \bool_set_false:N \l_otex_standard_font_detected_bool
  \tl_if_in:NnT \l_otex_rmdefault_tl { cmr } { \bool_set_true:N \l_otex_standard_font_detected_bool }
  \tl_if_in:NnT \l_otex_rmdefault_tl { lmr } { \bool_set_true:N \l_otex_standard_font_detected_bool }

  \bool_if:NTF \l_otex_standard_font_detected_bool
  {
    % 检测环境纯净：内核标准字体在线，可安全执行预设覆盖
  }
  {
    % 锁定非标字体：检测到外部指令 (如 ppl/mathpazo)，otex 强制转入被动保护模式。
    \msg_new:nnn { otex } { font-backoff } { Non-standard~font~family~'\tl_use:N \l_otex_rmdefault_tl'~detected.~Preserving~external~font~settings. }
    \msg_warning:nn { otex } { font-backoff }
    \tl_gset:Nn \g_otex_font_set_tl { none }
  }
}

% 被动模式出口：若已触发退避逻辑，则立即终止加载过程，规避对 fontspec 的二次调用
\str_if_eq:VnT \g_otex_font_set_tl { none } { \endinput }

\RequirePackage { fontspec }

\tl_if_empty:NF \g_otex_fonts_dir_tl
{
  \defaultfontfeatures+ { Path = \g_otex_fonts_dir_tl / }
}

% 自动推断逻辑：依据所在的操作系统环境 (Windows/macOS/Linux) 智能匹配最佳的系统字体预设
\str_if_eq:VnT \g_otex_font_set_tl { auto }
{
  \str_if_eq:VnTF \c_sys_platform_str { windows }
  { \tl_gset:Nn \g_otex_font_set_tl { windows } }
  {
    \str_if_eq:VnTF \c_sys_platform_str { macos }
    { \tl_gset:Nn \g_otex_font_set_tl { adobe } }
    { \tl_gset:Nn \g_otex_font_set_tl { linux } }
  }
}

% 辅助函数
\cs_new:Nn \otex_set_font:nnn
{
  \tl_if_empty:NTF #1 { #2 { #3 } } { #2 { #1 } }
}

% 预设
\str_case:Vn \g_otex_font_set_tl
{
  {windows}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Times~New~Roman }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Arial }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Courier~New }
  }
  {linux}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Liberation~Serif }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Liberation~Sans }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Liberation~Mono }
  }
  {adobe}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Source~Serif~Pro }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Source~Sans~Pro }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Source~Code~Pro }
  }
}

% CJK 辅助函数
\cs_new:Nn \otex_set_cjk_font:nnn
{
  \tl_if_empty:NTF #1 { #2 { #3 } } { #2 { #1 } }
}

% CJK
\bool_if:NT \g_otex_load_ctex_bool
{
  \@ifpackageloaded{xeCJK}
  {
    % 确定预设默认值
    \tl_set:Nn \l_otex_cjk_main_default_tl { SimSun }
    \tl_set:Nn \l_otex_cjk_sans_default_tl { SimHei }
    \tl_set:Nn \l_otex_cjk_mono_default_tl { FangSong }
    \str_case:VnF \g_otex_font_set_tl
    {
      {linux} {
        \tl_set:Nn \l_otex_cjk_main_default_tl { Noto~Serif~CJK~SC }
        \tl_set:Nn \l_otex_cjk_sans_default_tl { Noto~Sans~CJK~SC }
        \tl_set:Nn \l_otex_cjk_mono_default_tl { Noto~Sans~Mono~CJK~SC }
      }
      {adobe} {
        \tl_set:Nn \l_otex_cjk_main_default_tl { Source~Han~Serif~CN }
        \tl_set:Nn \l_otex_cjk_sans_default_tl { Source~Han~Sans~CN }
        \tl_set:Nn \l_otex_cjk_mono_default_tl { Source~Han~Sans~CN }
      }
    }
    {}
    % 应用带有用户覆盖项的字体
    \otex_set_cjk_font:nnn \g_otex_font_cjk_main_tl \setCJKmainfont { \l_otex_cjk_main_default_tl }
    \otex_set_cjk_font:nnn \g_otex_font_cjk_sans_tl \setCJKsansfont { \l_otex_cjk_sans_default_tl }
    \otex_set_cjk_font:nnn \g_otex_font_cjk_mono_tl \setCJKmonofont { \l_otex_cjk_mono_default_tl }
  }
  {}
}

% 现代数学字体适配：仅在用户通过全局选项明确指定数学字体时，才启用 unicode-math 的动态配置
\@ifpackageloaded{unicode-math}
{
  \tl_if_empty:NF \g_otex_font_math_tl
  { \setmathfont { \g_otex_font_math_tl } }
}
{}

\endinput
