\ProvidesExplPackage {otex/otex-fonts} {2026-01-17} {1.2} {Orion's Font Configuration}

\bool_if:NF \g_otex_load_fonts_bool { \endinput }

% pdfTeX 引擎检测：fontspec 仅支持 XeTeX/LuaTeX
\sys_if_engine_pdftex:T
{
  \msg_new:nnn { otex } { fonts-pdftex-skip } { pdfTeX~detected.~Skipping~fontspec~(requires~XeTeX/LuaTeX). }
  \msg_warning:nn { otex } { fonts-pdftex-skip }
  \endinput
}

% Dynamic Font Preservation Check (MUST be done before loading fontspec)
% Check if \rmdefault is standard (cmr) or if fontspec has already normalized it.
% If the user hasn't explicitly set a font set (auto), and we detect a custom font, back off.
\str_if_eq:VnT \g_otex_font_set_tl { auto }
{
  \tl_set:Nx \l_otex_rmdefault_tl { \rmdefault }

  \bool_set_false:N \l_otex_standard_font_detected_bool
  \tl_if_in:NnT \l_otex_rmdefault_tl { cmr } { \bool_set_true:N \l_otex_standard_font_detected_bool }
  \tl_if_in:NnT \l_otex_rmdefault_tl { lmr } { \bool_set_true:N \l_otex_standard_font_detected_bool }

  \bool_if:NTF \l_otex_standard_font_detected_bool
  {
    % Standard fonts detected, likely safe to proceed.
  }
  {
    % Non-standard font detected (e.g. ppl/mathpazo), back off completely.
    \msg_new:nnn { otex } { font-backoff } { Non-standard~font~family~'\tl_use:N \l_otex_rmdefault_tl'~detected.~Preserving~external~font~settings. }
    \msg_warning:nn { otex } { font-backoff }
    \tl_gset:Nn \g_otex_font_set_tl { none }
  }
}

% If font set is none, exit early to avoid loading fontspec and overwriting fonts
\str_if_eq:VnT \g_otex_font_set_tl { none } { \endinput }

\RequirePackage { fontspec }

\tl_if_empty:NF \g_otex_fonts_dir_tl
{
  \defaultfontfeatures+ { Path = \g_otex_fonts_dir_tl / }
}

% Resolve platform defaults (only if not backed off)
\str_if_eq:VnT \g_otex_font_set_tl { auto }
{
  \str_if_eq:VnTF \c_sys_platform_str { windows }
  { \tl_gset:Nn \g_otex_font_set_tl { windows } }
  {
    \str_if_eq:VnTF \c_sys_platform_str { macos }
    { \tl_gset:Nn \g_otex_font_set_tl { adobe } }
    { \tl_gset:Nn \g_otex_font_set_tl { linux } }
  }
}

% Helper
\cs_new:Nn \otex_set_font:nnn
{
  \tl_if_empty:NTF #1 { #2 { #3 } } { #2 { #1 } }
}

% Presets
\str_case:Vn \g_otex_font_set_tl
{
  {windows}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Times~New~Roman }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Arial }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Courier~New }
  }
  {linux}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Liberation~Serif }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Liberation~Sans }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Liberation~Mono }
  }
  {adobe}
  {
    \otex_set_font:nnn \g_otex_font_main_tl \setmainfont { Source~Serif~Pro }
    \otex_set_font:nnn \g_otex_font_sans_tl \setsansfont { Source~Sans~Pro }
    \otex_set_font:nnn \g_otex_font_mono_tl \setmonofont { Source~Code~Pro }
  }
}

% CJK Helper
\cs_new:Nn \otex_set_cjk_font:nnn
{
  \tl_if_empty:NTF #1 { #2 { #3 } } { #2 { #1 } }
}

% CJK
\bool_if:NT \g_otex_load_ctex_bool
{
  \@ifpackageloaded{xeCJK}
  {
    % Determine preset defaults
    \tl_set:Nn \l_otex_cjk_main_default_tl { SimSun }
    \tl_set:Nn \l_otex_cjk_sans_default_tl { SimHei }
    \tl_set:Nn \l_otex_cjk_mono_default_tl { FangSong }
    \str_case:VnF \g_otex_font_set_tl
    {
      {linux} {
        \tl_set:Nn \l_otex_cjk_main_default_tl { Noto~Serif~CJK~SC }
        \tl_set:Nn \l_otex_cjk_sans_default_tl { Noto~Sans~CJK~SC }
        \tl_set:Nn \l_otex_cjk_mono_default_tl { Noto~Sans~Mono~CJK~SC }
      }
      {adobe} {
        \tl_set:Nn \l_otex_cjk_main_default_tl { Source~Han~Serif~CN }
        \tl_set:Nn \l_otex_cjk_sans_default_tl { Source~Han~Sans~CN }
        \tl_set:Nn \l_otex_cjk_mono_default_tl { Source~Han~Sans~CN }
      }
    }
    {}
    % Apply fonts with user overrides
    \otex_set_cjk_font:nnn \g_otex_font_cjk_main_tl \setCJKmainfont { \l_otex_cjk_main_default_tl }
    \otex_set_cjk_font:nnn \g_otex_font_cjk_sans_tl \setCJKsansfont { \l_otex_cjk_sans_default_tl }
    \otex_set_cjk_font:nnn \g_otex_font_cjk_mono_tl \setCJKmonofont { \l_otex_cjk_mono_default_tl }
  }
  {}
}

% Math: Only set font if user explicitly specified one
\@ifpackageloaded{unicode-math}
{
  \tl_if_empty:NF \g_otex_font_math_tl
  { \setmathfont { \g_otex_font_math_tl } }
}
{}

\endinput
