\ProvidesExplPackage {otex/otex-math} {2026-01-16} {1.1} {Orion's Math Enhancements}

% Standard Math (Safe Load)
\otex_safe_require:nnnn { amsmath } {} {} {}
\otex_safe_require:nnnn { mathtools } {} {} {}

% amsthm: Safe load (Guard: \theoremstyle)
\otex_safe_require:nnnn { amsthm } {} { \theoremstyle } {}

\msg_new:nnn { otex } { amssymb-conflict } { Package~'amssymb'~conflict~with~'unicode-math'. }
\msg_new:nnn { otex } { math-pkg-backoff } { Legacy~math~package~'#1'~detected.~Disabling~unicode-math. }

% Logic: If pdfTeX or Font Package Detected -> Standard. Else -> Unicode Math.
\bool_new:N \l_otex_math_conflict_bool

% Dynamic detection of legacy math font packages and bm (boldsymbol conflicts with unicode-math)
\clist_map_inline:nn { mathpazo, newtxmath, fourier, stix, stix2, mtpro2, eulervm, bm }
{
  \@ifpackageloaded{#1}
  {
    \bool_set_true:N \l_otex_math_conflict_bool
    \msg_warning:nnn { otex } { math-pkg-backoff } { #1 }
  }
  {}
}
% Also check if class has set a flag (optional, but good practice) or simply rely on package loading.

\bool_lazy_or:nnTF { \sys_if_engine_pdftex_p: } { \l_otex_math_conflict_bool }
{
  % pdfTeX 或检测到传统数学包 -> 使用 amssymb
  \sys_if_engine_pdftex:T
  {
    \msg_new:nnn { otex } { math-pdftex } { pdfTeX~detected.~Using~amssymb~instead~of~unicode-math. }
    \msg_warning:nn { otex } { math-pdftex }
  }
  \otex_safe_require:nnnn { amsmath } {} {} {}
  % Load amssymb only if its symbols are not already provided (Guard: \Bbbk)
  \otex_safe_require:nnnn { amssymb } {} { \Bbbk } {}
}
{
  % Unicode Math
  \@ifpackageloaded{amssymb} { \msg_warning:nn { otex } { amssymb-conflict } } {}

  % Unicode Math (Safe Load)
  % Guard: \setmathfont (though less likely to be defined by others without package)
  \@ifpackageloaded{amssymb} { \msg_warning:nn { otex } { amssymb-conflict } } {}

  \otex_safe_require:nnnn { unicode-math } { math-style=ISO, bold-style=ISO } { \setmathfont }
  {
    \otex_provide_command:Nnn \square { } { \mdlgwhtsquare }
    \otex_provide_command:Nnn \boxtimes { } { \boxtimes }
  }
}

\endinput
