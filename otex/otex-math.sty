\ProvidesExplPackage {otex/otex-math} {2026-01-16} {1.1} {Orion's Math Enhancements}

% 数学核心支持：安全地加载 amsmath 和 mathtools，确保基础数学符号库可用
\otex_safe_require:nnnn { amsmath } {} {} {}
\otex_safe_require:nnnn { mathtools } {} {} {}

% 定理支撑 (amsthm)：配置定理环境样式，通过 \theoremstyle 探测避免与 ntheorem 等宏包冲突
\otex_safe_require:nnnn { amsthm } {} { \theoremstyle } {}

% 智能路由：根据编译引擎和已有宏包自动选择数学支持方案。
% 1. pdfTeX 引擎：不支持 unicode-math，回退至 amssymb。
% 2. XeTeX/LuaTeX 引擎：尝试加载 unicode-math。
%    - 若存在互斥包 (如 mathptmx)，otex_safe_require 会自动跳过 unicode-math。
%    - 若 unicode-math 未加载 (因冲突跳过)，则回退至 amssymb 以确保兼容性。

\sys_if_engine_pdftex:TF
{
  \msg_new:nnn { otex } { math-pdftex } { pdfTeX~detected.~Using~amssymb~instead~of~unicode-math. }
  \msg_warning:nn { otex } { math-pdftex }
  \otex_safe_require:nnnn { amssymb } {} { \Bbbk } {}
}
{
  % 尝试加载 unicode-math
  % 冲突检测由 otex-pkgconflict 自动处理 (Group 1: Math Fonts)
  \otex_safe_require:nnnn { unicode-math } { math-style=ISO, bold-style=ISO } { \setmathfont }
  {
    \otex_provide_command:Nnn \square { } { \mdlgwhtsquare }
    \otex_provide_command:Nnn \boxtimes { } { \boxtimes }
  }

  % 状态检查：如果 unicode-math 因冲突被跳过，则加载 amssymb 作为保底
  \IfPackageLoadedTF { unicode-math }
  {
    \msg_new:nnn { otex } { amssymb-conflict } { Package~'amssymb'~conflict~with~'unicode-math'. }
    \@ifpackageloaded{amssymb} { \msg_warning:nn { otex } { amssymb-conflict } } {}
  }
  {
    \otex_safe_require:nnnn { amssymb } {} { \Bbbk } {}
  }
}

\endinput
