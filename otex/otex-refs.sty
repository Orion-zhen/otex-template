\ProvidesExplPackage {otex/otex-refs} {2026-01-16} {1.1} {Orion's References}

\bool_if:NT \g_otex_load_hyperref_bool
{
  % Use AtBeginDocument to handle classes that load hyperref late (like mdpi)
  % or with specific options.
  % Load citation dependency
  \bool_if:NF \g_otex_load_bib_bool { \otex_safe_require:nnnn { cite } {} {} {} }

  % [Explicit Class Detection for Hyperref Passive Mode]
  \bool_new:N \l_otex_hyperref_passive_bool
  \bool_set_false:N \l_otex_hyperref_passive_bool

  \@ifclassloaded{mdpi}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}
  \@ifclassloaded{acmart}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}
  \@ifclassloaded{beamer}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}

  \msg_new:nnn { otex } { hyperref-active }
  {
    Hyperref~loading~mode:~ACTIVE.~(Loading~immediately). \\
    If~you~encounter~hook~errors,~your~document~class~might~need~Passive~Mode.
  }
  \msg_new:nnn { otex } { hyperref-passive }
  {
    Hyperref~loading~mode:~PASSIVE.~(Waiting~for~class). \\
    Complex~class~detected.~Skipping~immediate~load.
  }

  % Common Configuration Hook (Meta Info) - Running for BOTH Active and Passive
  \otex_setup_package:nn { hyperref }
  {
    \hypersetup{
      pdftitle   = { \g_otex_pdf_title_tl },
      pdfauthor  = { \g_otex_pdf_author_tl },
      pdfcreator = { LaTeX~with~otex },
    }

    % Cleveref Logic: Load it AFTER hyperref is loaded
    \bool_if:NT \g_otex_load_cleveref_bool
    {
      \bool_if:NTF \l_otex_hyperref_passive_bool
      {
        % Passive Mode: The CLASS will load cleveref (e.g. mdpi loads it).
        % We just pass options and setup configurations.
        \PassOptionsToPackage { capitalise, nameinlink } { cleveref }

        \otex_setup_package:nn { cleveref }
        {
          \bool_if:NF \g_otex_english_bool
          {
            \crefname{figure}{图}{图}
            \crefname{table}{表}{表}
            \crefname{equation}{式}{式}
            \crefname{theorem}{定理}{定理}
            \crefname{lemma}{引理}{引理}
          }
        }
      }
      {
        % Active Mode: We are responsible for loading it safely.
        \otex_safe_require:nnnn { cleveref } { capitalise, nameinlink } {}
        {
          \bool_if:NF \g_otex_english_bool
          {
            \crefname{figure}{图}{图}
            \crefname{table}{表}{表}
            \crefname{equation}{式}{式}
            \crefname{theorem}{定理}{定理}
            \crefname{lemma}{引理}{引理}
          }
        }
      }
    }
  }

  % Common Styling Options (Applied only if otex loads hyperref)
  \clist_set:Nn \l_tmpa_clist
  {
    colorlinks = true,
    linkcolor  = black,
    filecolor  = magenta,
    urlcolor   = cyan!70!black,
    citecolor  = green!40!black
  }

  \bool_if:NTF \l_otex_hyperref_passive_bool
  {
    \msg_warning:nn { otex } { hyperref-passive }
    % Passive: Wait until begin document to see if class loaded it
    \AtBeginDocument
    {
      \otex_safe_require:nnnn { hyperref } { \l_tmpa_clist } {} {}
    }
  }
  {
    \msg_warning:nn { otex } { hyperref-active }
    % Active: Load immediately
    \otex_safe_require:nnnn { hyperref } { \l_tmpa_clist } {} {}
  }
}

\endinput
