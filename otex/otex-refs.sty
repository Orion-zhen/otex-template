\ProvidesExplPackage {otex/otex-refs} {2026-01-16} {1.1} {Orion's References}

\bool_if:NT \g_otex_load_hyperref_bool
{
  % 生命周期管理：利用 AtBeginDocument 处理延迟加载场景 (如 mdpi 宏包后续动作)
  % 从而确保所有超链接配置在最终渲染时刻准确生效
  % 构建引用基石：安全解析文献包依赖关系
  \bool_if:NF \g_otex_load_bib_bool { \otex_safe_require:nnnn { cite } {} {} {} }

  % [引擎策略：针对特定文档类的“被动接管”模式白名单]
  \bool_new:N \l_otex_hyperref_passive_bool
  \bool_set_false:N \l_otex_hyperref_passive_bool

  \@ifclassloaded{mdpi}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}
  \@ifclassloaded{acmart}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}
  \@ifclassloaded{beamer}{ \bool_set_true:N \l_otex_hyperref_passive_bool }{}

  \msg_new:nnn { otex } { hyperref-active }
  {
    Hyperref~loading~mode:~ACTIVE.~(Loading~immediately). \\
    If~you~encounter~hook~errors,~your~document~class~might~need~Passive~Mode.
  }
  \msg_new:nnn { otex } { hyperref-passive }
  {
    Hyperref~loading~mode:~PASSIVE.~(Waiting~for~class). \\
    Complex~class~detected.~Skipping~immediate~load.
  }

  % 基础元数据注册：无论在主动还是被动模式下，均需向 PDF 文档写入标题与作者信息
  \otex_setup_package:nn { hyperref }
  {
    \hypersetup{
      pdftitle   = { \g_otex_pdf_title_tl },
      pdfauthor  = { \g_otex_pdf_author_tl },
      pdfcreator = { LaTeX~with~otex },
    }

    % 智能排序：Cleveref 必须在 hyperref 激活后方可执行配置逻辑
    \bool_if:NT \g_otex_load_cleveref_bool
    {
      \bool_if:NTF \l_otex_hyperref_passive_bool
      {
        % 被动注册：信任文档类自带的 cleveref 加载动作，我们仅负责注入学术样式预设
        \PassOptionsToPackage { capitalise, nameinlink } { cleveref }

        \otex_setup_package:nn { cleveref }
        {
          \bool_if:NF \g_otex_english_bool
          {
            \crefname{figure}{图}{图}
            \crefname{table}{表}{表}
            \crefname{equation}{式}{式}
            \crefname{theorem}{定理}{定理}
            \crefname{lemma}{引理}{引理}
          }
        }
      }
      {
        % 主动介入：执行正式的安全加载逻辑，并同步完成标签国际化处理
        \otex_safe_require:nnnn { cleveref } { capitalise, nameinlink } {}
        {
          \bool_if:NF \g_otex_english_bool
          {
            \crefname{figure}{图}{图}
            \crefname{table}{表}{表}
            \crefname{equation}{式}{式}
            \crefname{theorem}{定理}{定理}
            \crefname{lemma}{引理}{引理}
          }
        }
      }
    }
  }

  % 视觉风格对齐：配置全局链接色彩方案 (仅在 hyperref 由本模块驱动时生效)
  \clist_set:Nn \l_tmpa_clist
  {
    colorlinks = true,
    linkcolor  = black,
    filecolor  = magenta,
    urlcolor   = cyan!70!black,
    citecolor  = green!40!black
  }

  \bool_if:NTF \l_otex_hyperref_passive_bool
  {
    \msg_warning:nn { otex } { hyperref-passive }
    % 观察策略：被动等待文档类加载流程结束，并在 \begin{document} 时刻进行检查补齐
    \AtBeginDocument
    {
      \otex_safe_require:nnnn { hyperref } { \l_tmpa_clist } {} {}
    }
  }
  {
    \msg_warning:nn { otex } { hyperref-active }
    % 积极策略：规避冲突风险，立即执行正式加载
    \otex_safe_require:nnnn { hyperref } { \l_tmpa_clist } {} {}
  }
}

\endinput
